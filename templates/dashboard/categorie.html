{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Gestion des Cat√©gories | LuxeShop{% endblock %}

{% block content %}
<!-- En-t√™te de page -->
<div class="page-header">
    <div class="page-title">
        <h1>Gestion des Cat√©gories</h1>
        <p>G√©rez les cat√©gories de votre catalogue produits</p>
    </div>
    
    <div class="page-actions">
        <button class="btn btn-outline" onclick="exportCategories()">
            <i class="fas fa-download"></i> Exporter
        </button>
        <button class="btn" onclick="showAddForm()">
            <i class="fas fa-plus"></i> Nouvelle Cat√©gorie
        </button>
    </div>
</div>

<!-- Cartes de Statistiques -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon">
                <i class="fas fa-tags"></i>
            </div>
            <div class="stat-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                +5.2%
            </div>
        </div>
        <div class="stat-value" id="totalCategories">0</div>
        <div class="stat-label">Cat√©gories totales</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="stat-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                +12.1%
            </div>
        </div>
        <div class="stat-value" id="totalProducts">0</div>
        <div class="stat-label">Produits total</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="stat-trend trend-up">
                <i class="fas fa-arrow-up"></i>
                +3.4%
            </div>
        </div>
        <div class="stat-value" id="activeCategories">0</div>
        <div class="stat-label">Cat√©gories actives</div>
    </div>
</div>

<!-- Formulaire d'ajout -->
<div class="form-card" id="addForm" style="display: none;">
    <div class="form-header">
        <h3>Ajouter une nouvelle cat√©gorie</h3>
        <button class="btn-close" onclick="hideAddForm()">
            <i class="fas fa-times"></i>
        </button>
    </div>
   <form id="productForm" class="grid grid-cols-2 gap-3">
    {% csrf_token %}
    <input type="text" id="name" placeholder="Nom du produit" required class="border p-2 rounded">
    <input type="number" id="price" placeholder="Prix" step="0.01" required class="border p-2 rounded">
    <input type="number" id="stock" placeholder="Stock" required class="border p-2 rounded">
    <select id="category" required class="border p-2 rounded">
        <option value="">S√©lectionnez une cat√©gorie</option>
    </select>
    <textarea id="description" placeholder="Description" class="border p-2 col-span-2 rounded"></textarea>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 col-span-2">
        Ajouter le produit
    </button>
</form>

</div>

<!-- Tableau des cat√©gories -->
<div class="table-card">
    <div class="table-header">
        <h3>Liste des cat√©gories</h3>
        <div class="table-actions">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Rechercher une cat√©gorie...">
            </div>
            <button class="btn btn-sm btn-outline" onclick="loadCategories()">
                <i class="fas fa-refresh"></i> Actualiser
            </button>
        </div>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom</th>
                    <th>Description</th>
                    <th>Produits</th>
                    <th>Cr√©√© le</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="categoriesTable">
                <tr>
                    <td colspan="7" class="text-center">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            Chargement des cat√©gories...
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="table-footer">
        <div class="table-info">
            Affichage de <span id="showingCount">0</span> sur <span id="totalCount">0</span> cat√©gories
        </div>
        <div class="table-pagination">
            <button class="btn btn-sm btn-outline" id="prevBtn" disabled>
                <i class="fas fa-chevron-left"></i> Pr√©c√©dent
            </button>
            <span class="pagination-info">Page <span id="currentPage">1</span></span>
            <button class="btn btn-sm btn-outline" id="nextBtn" disabled>
                Suivant <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal-overlay" id="deleteModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>Confirmer la suppression</h3>
            <button class="btn-close" onclick="closeDeleteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "<strong id="deleteCategoryName"></strong>" ?</p>
            <p class="text-warning">Cette action est irr√©versible et affectera tous les produits associ√©s.</p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-outline" onclick="closeDeleteModal()">Annuler</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">
                <i class="fas fa-trash"></i> Supprimer
            </button>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    console.log("‚úÖ DOM charg√©, initialisation du script produits...");

    // Fonction pour r√©cup√©rer le cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    const BASE_URL = "http://127.0.0.1:9000/api/catalogue/";
    const PRODUCTS_URL = `${BASE_URL}products/`;
    const CATEGORIES_URL = `${BASE_URL}categories/`;

    // R√©f√©rences DOM
    const productForm = document.getElementById("productForm");
    const tableBody = document.getElementById("productsTable");
    const categorySelect = document.getElementById("category");

    if (!productForm || !tableBody || !categorySelect) {
        console.error("‚ùå Erreur : certains √©l√©ments du DOM n'ont pas √©t√© trouv√©s !");
        return;
    }

    // üîπ Charger les cat√©gories
    async function loadCategories() {
        try {
            const res = await fetch(CATEGORIES_URL);
            const categories = await res.json();
            categorySelect.innerHTML = '<option value="">S√©lectionnez une cat√©gorie</option>';
            categories.forEach(cat => {
                categorySelect.insertAdjacentHTML(
                    'beforeend',
                    `<option value="${cat.id}">${cat.name}</option>`
                );
            });
            console.log("‚úÖ Cat√©gories charg√©es :", categories);
        } catch (err) {
            console.error("Erreur chargement cat√©gories :", err);
        }
    }

    // üîπ Charger les produits
    async function loadProducts() {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-3 text-gray-500">Chargement...</td></tr>';
        try {
            const res = await fetch(PRODUCTS_URL);
            const products = await res.json();

            if (!Array.isArray(products) || products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-3 text-gray-500">Aucun produit trouv√©.</td></tr>';
                return;
            }

            tableBody.innerHTML = "";
            products.forEach(prod => {
                const row = `
                    <tr>
                        <td class="border p-2">${prod.id}</td>
                        <td class="border p-2">${prod.title}</td>
                        <td class="border p-2">${prod.category_name || "-"}</td>
                        <td class="border p-2">${prod.price} FCFA</td>
                        <td class="border p-2">${prod.stock}</td>
                        <td class="border p-2 text-center">
                            <button onclick="deleteProduct('${prod.id}')" 
                                class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                                Supprimer
                            </button>
                        </td>
                    </tr>`;
                tableBody.insertAdjacentHTML("beforeend", row);
            });
        } catch (err) {
            console.error("Erreur chargement produits :", err);
        }
    }

    // üîπ Ajouter un produit
    productForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("üü¢ Soumission du formulaire d√©clench√©e !");

        const data = {
            title: document.getElementById("name").value.trim(),
            description: document.getElementById("description").value.trim(),
            price: parseFloat(document.getElementById("price").value),
            stock: parseInt(document.getElementById("stock").value),
            category: document.getElementById("category").value
        };

        console.log("üì¶ Donn√©es envoy√©es :", data);

        if (!data.title || !data.category) {
            alert("Veuillez remplir tous les champs obligatoires.");
            return;
        }

        try {
            const res = await fetch(PRODUCTS_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
                body: JSON.stringify(data),
            });

            if (res.ok) {
                alert("‚úÖ Produit ajout√© avec succ√®s !");
                productForm.reset();
                await loadProducts();
            } else {
                const err = await res.json();
                alert("‚ùå Erreur : " + JSON.stringify(err));
                console.error("Erreur serveur :", err);
            }
        } catch (err) {
            console.error("Erreur d‚Äôajout :", err);
        }
    });

    // üîπ Supprimer un produit
    window.deleteProduct = async (id) => {
        if (!confirm("Supprimer ce produit ?")) return;
        try {
            const res = await fetch(`${PRODUCTS_URL}${id}/`, {
                method: "DELETE",
                headers: { "X-CSRFToken": csrftoken },
            });
            if (res.ok) {
                alert("‚úÖ Produit supprim√© !");
                loadProducts();
            } else {
                alert("Erreur lors de la suppression.");
            }
        } catch (err) {
            console.error("Erreur suppression :", err);
        }
    };

    // üîπ Initialisation
    loadCategories();
    loadProducts();
});
</script>
{% endblock %}
{% block extra_css %}

<style>
.category-avatar {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: var(--primary-color, #3498db);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.btn-icon {
    padding: 8px;
    border: none;
    border-radius: 6px;
    background: #f8f9fa;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: #e9ecef;
    color: #495057;
}

.btn-danger {
    background: #fff5f5;
    color: #e53e3e;
}

.btn-danger:hover {
    background: #fed7d7;
    color: #c53030;
}

.loading-spinner {
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    padding: 20px;
    color: #6c757d;
}

.text-center { text-align: center; }
.text-muted { color: #6c757d; }
.text-error { color: #e53e3e; }
.text-warning { color: #dd6b20; }

.flex { display: flex; }
.items-center { align-items: center; }
.gap-3 { gap: 12px; }

.badge {
    background: #e9ecef;
    color: #495057;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}
</style>
{% endblock %}